# Global Workflow State Object Schema

This document defines the structure of the shared state object that is managed by the Queen and passed between Worker agents. It is implemented as a Pydantic model to ensure type safety and data consistency.

```python
from pydantic import BaseModel, FilePath, DirectoryPath
from typing import Dict, Any, List

class GlobalWorkflowState(BaseModel):
    # =================================================================
    # == Initial inputs from the user
    # =================================================================
    user_task_description: str
    source_json_path: FilePath
    source_spec_path: FilePath
    target_spec_path: FilePath
    source_collection_name: str
    target_collection_name: str
    output_directory: DirectoryPath

    # =================================================================
    # == Artifacts and status generated by Worker agents
    # =================================================================
    rag_setup_complete: bool = False
    preflight_ok: bool = False
    rag_collections: List[str] = []
    source_field_analysis_path: FilePath | None = None
    field_mapping_report_path: FilePath | None = None
    triangulation_summary_path: FilePath | None = None
    verification_report_path: FilePath | None = None
    verification_passed: bool = False
    human_approval_received: bool = False
    generated_kotlin_code_path: FilePath | None = None
    test_results: Dict[str, Any] | None = None
    
    # =================================================================
    # == Phase 3 Code Generation Artifacts (NEW)
    # =================================================================
    direct_mapping_code_path: FilePath | None = None
    direct_mapped_fields: List[str] | None = None
    direct_mapping_count: int | None = None
    
    type_conversion_code_path: FilePath | None = None
    conversion_functions: List[str] | None = None
    integrated_conversion_code_path: FilePath | None = None
    
    complex_logic_code_path: FilePath | None = None
    complex_function_names: List[str] | None = None
    integration_points: Dict[str, str] | None = None
    
    tdd_test_suite_path: FilePath | None = None
    test_cases_count: int | None = None
    test_coverage_summary: Dict[str, Any] | None = None

    # =================================================================
    # == Planning, clarification, and finalization artifacts
    # =================================================================
    execution_plan_path: FilePath | None = None
    clarifications: Dict[str, Any] | None = None
    integration_directory: DirectoryPath | None = None
    integration_spec_path: FilePath | None = None
    mapping_json_path: FilePath | None = None
    memory_log_path: FilePath | None = None
    guidelines_digest_path: FilePath | None = None

    # =================================================================
    # == Cognitive principles: BDI, Metacognition, CoT/ReAct
    # =================================================================
    # BDI summaries captured during planning and updated during execution
    beliefs_summary: str | None = None
    desires: List[str] | None = None
    intentions_checklist: List[str] | None = None

    # Metacognition controls and telemetry
    agent_confidence_threshold: float = 0.6
    field_confidences: Dict[str, float] | None = None
    uncertainty_flags: List[str] | None = None
    metacognition_notes: str | None = None

    # CoT/ReAct traces (concise and structured)
    rationale_briefs: Dict[str, str] | None = None  # per-field short rationale
    actions_trace: List[Dict[str, Any]] | None = None  # sequence of {reason, action, observation}

---

### `memory-protocol.md` (New File)

```markdown
# Swarm Memory Protocol

This protocol defines the structure and rules for the swarm's long-term memory, which is stored in `memory.log.md`. This file serves as a detailed, human-readable audit trail of every significant agent action.

## üèõÔ∏è Core Concept

After every successful or failed task delegation to a Worker agent, the Queen Agent **must** append a new entry to the `memory.log.md` file. This creates a persistent record of the swarm's "experience."

## üìú Log Entry Schema

Each entry in the log must be a Markdown block with the following structure:

```markdown
---
- **Timestamp**: `YYYY-MM-DD HH:MM:SS`
- **WorkflowID**: `A unique ID for the entire integration task`
- **TaskID**: `The ID of the task from workflow-definition.yaml`
- **WorkerAgent**: `The name of the Worker agent that was executed`
- **MCP_Tool(s)**: `The specific MCP tool(s) called`
- **Status**: `SUCCESS` or `FAILURE`
- **Summary of Findings**: `A concise, one-sentence summary of what was achieved or what went wrong.`
- **Output Artifact**: `The absolute path to the file generated by this step, or "N/A".`
- **Inputs Provided**:
  ```json
  {
    "input_parameter_1": "value_1",
    "input_parameter_2": "value_2"
  }

## üìù Example Log Entry

```markdown
---
- **Timestamp**: `2025-07-29 12:30:00`
- **WorkflowID**: `personio-to-workday-sync-1690626600`
- **TaskID**: `3`
- **WorkerAgent**: `MappingAgent`
- **MCP_Tool(s)**: `reasoning_agent`
- **Status**: `SUCCESS`
- **Summary of Findings**: `Successfully generated a mapping report with 8/10 fields matched with high confidence.`
- **Output Artifact**: `/path/to/project/outputs/mapping_report_20250729_123000.md`
- **Inputs Provided**:
  ```json
  {
    "analysis_path": "/path/to/project/outputs/source_analysis_20250729_122500.md",
    "spec_path": "/path/to/specs/workday.json",
    "collection_name": "workday_api_v3"
  }
 